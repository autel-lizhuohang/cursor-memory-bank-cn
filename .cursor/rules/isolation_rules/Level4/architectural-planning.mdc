---
description: Level 4 复杂系统任务的架构规划指南
globs: "**/level4/**", "**/architecture/**"
alwaysApply: false
---

# LEVEL 4 任务的架构规划

> **简述:** 本文档概述了 Level 4（复杂系统）任务的全面架构规划方法，确保构建出与业务目标和技术需求保持一致的健壮、可扩展和可维护的架构。

## 🔍 架构规划概述

Level 4 复杂系统任务需要彻底的架构规划，以确保最终系统健壮、可扩展、可维护，并与业务目标保持一致。本文档概述了一种结构化的架构规划方法，系统性地解决关键问题并生成全面的文档。

```mermaid
flowchart TD
    classDef phase fill:#f9d77e,stroke:#d9b95c,color:#000
    classDef artifact fill:#f4b8c4,stroke:#d498a4,color:#000
    classDef verification fill:#c5e8b7,stroke:#a5c897,color:#000

    Start([开始架构<br>规划]) --> Reqs[分析<br>需求]
    Reqs --> Context[定义业务<br>上下文]
    Context --> Vision[建立愿景<br>和目标]
    Vision --> Principles[定义架构<br>原则]
    Principles --> Constraints[识别<br>约束条件]
    Constraints --> Explore[探索<br>备选方案]
    Explore --> Evaluate[评估<br>选项]
    Evaluate --> Decision[记录<br>决策]
    Decision --> Create[创建架构<br>文档]
    Create --> Validate[验证<br>架构]
    Validate --> Communicate[沟通<br>架构]
    Communicate --> Verification{架构<br>验证}
    Verification -->|通过| Complete([架构规划<br>完成])
    Verification -->|失败| Revise[修订<br>架构]
    Revise --> Verification

    Reqs -.-> ReqDoc((需求<br>文档))
    Context -.-> ConDoc((上下文<br>文档))
    Vision -.-> VisDoc((愿景<br>文档))
    Principles -.-> PrinDoc((原则<br>文档))
    Explore -.-> AltDoc((备选方案<br>分析))
    Decision -.-> ADR((架构<br>决策记录))
    Create -.-> ArchDoc((架构<br>文档))

    class Start,Complete milestone
    class Reqs,Context,Vision,Principles,Constraints,Explore,Evaluate,Decision,Create,Validate,Communicate,Revise step
    class Verification verification
    class ReqDoc,ConDoc,VisDoc,PrinDoc,AltDoc,ADR,ArchDoc artifact
```

## 📋 架构规划原则

1. **业务对齐**: 架构必须直接支持业务目标和用户需求。
2. **面向未来**: 架构必须预见未来需求并便于变更。
3. **简洁性**: 在可能的情况下，优先选择简单的解决方案而非复杂的方案。
4. **关注点分离**: 系统应划分为职责最小重叠的不同组件。
5. **纵深防御**: 应采用多层安全控制。
6. **松耦合**: 组件应通过定义良好的接口进行交互，依赖最小化。
7. **高内聚**: 相关功能应组合在一起，无关功能应分离。
8. **弹性**: 架构应预见故障并提供恢复机制。
9. **可扩展性**: 架构应支持用户、数据和功能的增长。
10. **可度量性**: 架构应支持关键指标的监控和度量。

## 📋 架构需求分析

从全面的需求分析开始架构规划：

### 功能需求分析

```mermaid
flowchart LR
    classDef req fill:#f9d77e,stroke:#d9b95c,color:#000
    classDef arch fill:#a8d5ff,stroke:#88b5e0,color:#000

    FR[功能<br>需求] --> USE[用例/<br>用户故事]
    USE --> DOM[领域<br>模型]
    DOM --> COMP[组件<br>识别]
    COMP --> INT[接口<br>定义]
    INT --> FLOW[信息<br>流]

    class FR,USE,DOM req
    class COMP,INT,FLOW arch
```

**功能需求分析模板:**

```markdown
## 功能需求分析

### 关键用例
- 用例 1: [描述]
- 用例 2: [描述]
- 用例 3: [描述]

### 领域模型
- 实体 1: [描述和属性]
- 实体 2: [描述和属性]
- 实体 3: [描述和属性]
- 关系:
  - 实体 1 → 实体 2: [关系类型和描述]
  - 实体 2 → 实体 3: [关系类型和描述]

### 组件识别
- 组件 1: [描述和职责]
- 组件 2: [描述和职责]
- 组件 3: [描述和职责]

### 接口定义
- 接口 1: [描述、方法、参数]
- 接口 2: [描述、方法、参数]
- 接口 3: [描述、方法、参数]

### 信息流
- 流 1: [信息交换描述]
- 流 2: [信息交换描述]
- 流 3: [信息交换描述]
```

### 非功能需求分析

```mermaid
flowchart LR
    classDef req fill:#f9d77e,stroke:#d9b95c,color:#000
    classDef arch fill:#a8d5ff,stroke:#88b5e0,color:#000

    NFR[非功能<br>需求] --> PERF[性能<br>需求]
    NFR --> SEC[安全<br>需求]
    NFR --> SCAL[可扩展性<br>需求]
    NFR --> AVAIL[可用性<br>需求]
    NFR --> MAINT[可维护性<br>需求]

    PERF & SEC & SCAL & AVAIL & MAINT --> ARCH[架构<br>决策]

    class NFR,PERF,SEC,SCAL,AVAIL,MAINT req
    class ARCH arch
```

**非功能需求分析模板:**

```markdown
## 非功能需求分析

### 性能需求
- 响应时间: [需求]
- 吞吐量: [需求]
- 资源利用率: [需求]
- 架构影响: [对架构的影响]

### 安全需求
- 认证: [需求]
- 授权: [需求]
- 数据保护: [需求]
- 审计/日志: [需求]
- 架构影响: [对架构的影响]

### 可扩展性需求
- 用户可扩展性: [需求]
- 数据可扩展性: [需求]
- 事务可扩展性: [需求]
- 架构影响: [对架构的影响]

### 可用性需求
- 正常运行时间要求: [需求]
- 容错能力: [需求]
- 灾难恢复: [需求]
- 架构影响: [对架构的影响]

### 可维护性需求
- 模块化: [需求]
- 可扩展性: [需求]
- 可测试性: [需求]
- 架构影响: [对架构的影响]
```

## 📋 业务上下文文档

记录业务上下文以确保架构对齐：

```markdown
## 业务上下文文档

### 业务目标
- 目标 1: [描述]
- 目标 2: [描述]
- 目标 3: [描述]

### 关键干系人
- 干系人组 1: [描述、需求和关注点]
- 干系人组 2: [描述、需求和关注点]
- 干系人组 3: [描述、需求和关注点]

### 业务流程
- 流程 1: [描述和流程]
- 流程 2: [描述和流程]
- 流程 3: [描述和流程]

### 业务约束
- 约束 1: [描述和影响]
- 约束 2: [描述和影响]
- 约束 3: [描述和影响]

### 业务指标
- 指标 1: [描述和目标]
- 指标 2: [描述和目标]
- 指标 3: [描述和目标]

### 业务风险
- 风险 1: [描述、概率、影响和缓解措施]
- 风险 2: [描述、概率、影响和缓解措施]
- 风险 3: [描述、概率、影响和缓解措施]
```

## 📋 架构愿景和目标

记录架构愿景和目标：

```markdown
## 架构愿景和目标

### 愿景声明
[架构愿景的简洁陈述]

### 战略目标
- 目标 1: [描述和成功标准]
- 目标 2: [描述和成功标准]
- 目标 3: [描述和成功标准]

### 质量属性
- 质量属性 1: [描述和重要性]
- 质量属性 2: [描述和重要性]
- 质量属性 3: [描述和重要性]

### 技术路线图
- 短期 (0-6 个月): [关键架构里程碑]
- 中期 (6-18 个月): [关键架构里程碑]
- 长期 (18+ 个月): [关键架构里程碑]

### 关键成功指标
- 指标 1: [描述和度量方式]
- 指标 2: [描述和度量方式]
- 指标 3: [描述和度量方式]
```

## 📋 架构原则

记录架构原则以指导决策：

```markdown
## 架构原则

### 原则 1: [名称]
- **声明**: [原则的简洁陈述]
- **理由**: [此原则为何重要]
- **影响**: [此原则对架构意味着什么]
- **示例**: [应用此原则的示例]

### 原则 2: [名称]
- **声明**: [原则的简洁陈述]
- **理由**: [此原则为何重要]
- **影响**: [此原则对架构意味着什么]
- **示例**: [应用此原则的示例]

### 原则 3: [名称]
- **声明**: [原则的简洁陈述]
- **理由**: [此原则为何重要]
- **影响**: [此原则对架构意味着什么]
- **示例**: [应用此原则的示例]

...
```

## 📋 约束识别

记录影响架构决策的约束：

```markdown
## 架构约束

### 技术约束
- 约束 1: [描述和影响]
- 约束 2: [描述和影响]
- 约束 3: [描述和影响]

### 组织约束
- 约束 1: [描述和影响]
- 约束 2: [描述和影响]
- 约束 3: [描述和影响]

### 外部约束
- 约束 1: [描述和影响]
- 约束 2: [描述和影响]
- 约束 3: [描述和影响]

### 法规/合规约束
- 约束 1: [描述和影响]
- 约束 2: [描述和影响]
- 约束 3: [描述和影响]

### 资源约束
- 约束 1: [描述和影响]
- 约束 2: [描述和影响]
- 约束 3: [描述和影响]
```

## 📋 架构备选方案探索

记录和评估架构备选方案：

```markdown
## 架构备选方案

### 备选方案 1: [名称]
- **描述**: [备选方案的简要描述]
- **关键组件**:
  - 组件 1: [描述]
  - 组件 2: [描述]
  - 组件 3: [描述]
- **优点**:
  - [优点 1]
  - [优点 2]
  - [优点 3]
- **缺点**:
  - [缺点 1]
  - [缺点 2]
  - [缺点 3]
- **风险**:
  - [风险 1]
  - [风险 2]
  - [风险 3]
- **成本因素**:
  - [成本因素 1]
  - [成本因素 2]
  - [成本因素 3]
- **与需求的对齐程度**:
  - [此备选方案如何满足需求]

### 备选方案 2: [名称]
...

### 备选方案 3: [名称]
...

## 评估标准
- 标准 1: [描述和权重]
- 标准 2: [描述和权重]
- 标准 3: [描述和权重]

## 评估矩阵
| 标准 | 备选方案 1 | 备选方案 2 | 备选方案 3 |
|-----------|---------------|---------------|---------------|
| 标准 1 | 评分 | 评分 | 评分 |
| 标准 2 | 评分 | 评分 | 评分 |
| 标准 3 | 评分 | 评分 | 评分 |
| 总计 | 总分 | 总分 | 总分 |

## 推荐方案
[推荐架构方案的描述及其理由]
```

## 📋 架构决策记录 (ADR)

记录关键架构决策：

```markdown
# 架构决策记录: [决策标题]

## 状态
[提议/已接受/已弃用/已替代]

## 上下文
[上下文和问题陈述的描述]

## 决策
[所做决策的描述]

## 后果
[决策后果的描述]

## 考虑的备选方案
[考虑过的备选方案描述]

## 相关决策
[相关决策的引用]

## 备注
[其他备注和考虑事项]
```

## 📋 全面架构文档

创建全面的架构文档：

### 系统上下文图

```mermaid
flowchart TD
    classDef system fill:#f9d77e,stroke:#d9b95c,color:#000
    classDef external fill:#a8d5ff,stroke:#88b5e0,color:#000
    classDef user fill:#c5e8b7,stroke:#a5c897,color:#000

    U1[用户 1] --> S[系统]
    U2[用户 2] --> S
    S --> E1[外部<br>系统 1]
    S --> E2[外部<br>系统 2]
    S --> E3[外部<br>系统 3]

    class S system
    class E1,E2,E3 external
    class U1,U2 user
```

### 高层架构图

```mermaid
flowchart TD
    classDef frontend fill:#f9d77e,stroke:#d9b95c,color:#000
    classDef backend fill:#a8d5ff,stroke:#88b5e0,color:#000
    classDef data fill:#c5e8b7,stroke:#a5c897,color:#000
    classDef integration fill:#f4b8c4,stroke:#d498a4,color:#000

    U[用户] --> F[前端<br>层]
    F --> B[后端<br>层]
    B --> D[数据<br>层]
    B --> I[集成<br>层]
    I --> E[外部<br>系统]

    class F frontend
    class B backend
    class D data
    class I integration
    class U,E external
```

### 组件架构图

```mermaid
flowchart TD
    classDef ui fill:#f9d77e,stroke:#d9b95c,color:#000
    classDef service fill:#a8d5ff,stroke:#88b5e0,color:#000
    classDef data fill:#c5e8b7,stroke:#a5c897,color:#000

    UI[用户界面] --> API[API 网关]
    API --> S1[服务 1]
    API --> S2[服务 2]
    API --> S3[服务 3]
    S1 --> DB1[数据库 1]
    S2 --> DB1
    S2 --> DB2[数据库 2]
    S3 --> DB2

    class UI ui
    class API,S1,S2,S3 service
    class DB1,DB2 data
```

### 数据架构图

```mermaid
flowchart TD
    classDef entity fill:#f9d77e,stroke:#d9b95c,color:#000
    classDef relation fill:#a8d5ff,stroke:#88b5e0,color:#000

    E1[实体 1] -- 1:N --> E2[实体 2]
    E1 -- 1:1 --> E3[实体 3]
    E2 -- N:M --> E4[实体 4]
    E3 -- 1:N --> E4

    class E1,E2,E3,E4 entity
```

### 安全架构图

```mermaid
flowchart TD
    classDef security fill:#f9d77e,stroke:#d9b95c,color:#000
    classDef app fill:#a8d5ff,stroke:#88b5e0,color:#000

    U[用户] --> WAF[Web 应用<br>防火墙]
    WAF --> LB[负载<br>均衡器]
    LB --> API[API 网关]
    API --> AuthZ[授权<br>服务]
    API --> S1[服务 1]
    API --> S2[服务 2]
    AuthZ --> IAM[身份和<br>访问管理]

    class WAF,AuthZ,IAM security
    class API,S1,S2 app
    class U,LB external
```

### 部署架构图

```mermaid
flowchart TD
    classDef env fill:#f9d77e,stroke:#d9b95c,color:#000
    classDef component fill:#a8d5ff,stroke:#88b5e0,color:#000

    subgraph Production
    LB[负载均衡器] --> W1[Web 服务器 1]
    LB --> W2[Web 服务器 2]
    W1 & W2 --> A1[应用服务器 1]
    W1 & W2 --> A2[应用服务器 2]
    A1 & A2 --> DB[数据库<br>集群]
    end

    class Production env
    class LB,W1,W2,A1,A2,DB component
```

### 架构文档模板

```markdown
# 系统架构文档

## 1. 简介
- **目的**: [架构的目的]
- **范围**: [架构的范围]
- **受众**: [文档的目标受众]
- **参考文献**: [相关文档和参考]

## 2. 系统上下文
- **系统目的**: [系统目的的简要描述]
- **上下文图**: [系统上下文图]
- **外部系统**: [外部系统和接口描述]
- **用户类型**: [用户类型和交互描述]

## 3. 架构概述
- **架构风格**: [架构风格/模式描述]
- **高层架构**: [高层架构图]
- **关键组件**: [关键组件概述]
- **技术栈**: [技术栈概述]

## 4. 组件架构
- **组件图**: [组件架构图]
- **组件描述**:
  - 组件 1: [描述、职责、接口]
  - 组件 2: [描述、职责、接口]
  - 组件 3: [描述、职责、接口]
- **组件交互**: [组件交互描述]
- **API 规范**: [关键 API 概述]

## 5. 数据架构
- **数据模型**: [数据架构图]
- **实体描述**:
  - 实体 1: [描述、属性、关系]
  - 实体 2: [描述、属性、关系]
  - 实体 3: [描述、属性、关系]
- **数据存储**: [数据存储方法描述]
- **数据访问**: [数据访问模式描述]
- **数据迁移**: [数据迁移方法概述]

## 6. 安全架构
- **安全模型**: [安全架构图]
- **认证**: [认证方法]
- **授权**: [授权方法]
- **数据保护**: [数据保护机制]
- **安全控制**: [关键安全控制]
- **审计和日志**: [审计和日志方法]

## 7. 部署架构
- **部署模型**: [部署架构图]
- **环境描述**:
  - 环境 1: [描述和配置]
  - 环境 2: [描述和配置]
  - 环境 3: [描述和配置]
- **基础设施需求**: [基础设施需求]
- **扩展方法**: [扩展方法]

## 8. 质量属性
- **性能**: [性能特性和机制]
- **可扩展性**: [可扩展性方法]
- **可用性**: [可用性方法]
- **可维护性**: [可维护性方法]
- **可靠性**: [可靠性方法]
- **可移植性**: [可移植性考虑]

## 9. 横切关注点
- **日志**: [日志方法]
- **错误处理**: [错误处理方法]
- **监控**: [监控方法]
- **配置管理**: [配置管理方法]
- **国际化**: [国际化方法]

## 10. 架构决策
- [架构决策记录引用]

## 11. 风险和缓解措施
- 风险 1: [描述和缓解措施]
- 风险 2: [描述和缓解措施]
- 风险 3: [描述和缓解措施]

## 12. 术语表
- 术语 1: [定义]
- 术语 2: [定义]
- 术语 3: [定义]
```

## 📋 架构验证

根据需求和原则验证架构：

```markdown
## 架构验证

### 需求覆盖
- 需求 1: [已覆盖/部分覆盖/未覆盖] - [说明]
- 需求 2: [已覆盖/部分覆盖/未覆盖] - [说明]
- 需求 3: [已覆盖/部分覆盖/未覆盖] - [说明]

### 原则对齐
- 原则 1: [对齐/部分对齐/未对齐] - [说明]
- 原则 2: [对齐/部分对齐/未对齐] - [说明]
- 原则 3: [对齐/部分对齐/未对齐] - [说明]

### 质量属性场景
- 场景 1: [描述和验证]
- 场景 2: [描述和验证]
- 场景 3: [描述和验证]

### 架构评审发现
- 发现 1: [描述和解决方案]
- 发现 2: [描述和解决方案]
- 发现 3: [描述和解决方案]

### 风险评估
- 风险 1: [描述、概率、影响和缓解措施]
- 风险 2: [描述、概率、影响和缓解措施]
- 风险 3: [描述、概率、影响和缓解措施]

### 验证结果
[验证结果摘要和后续步骤]
```

## 📋 架构沟通

向干系人沟通架构：

```markdown
## 架构沟通计划

### 关键干系人
- 干系人组 1: [沟通需求]
- 干系人组 2: [沟通需求]
- 干系人组 3: [沟通需求]

### 沟通材料
- **执行摘要**: [目的和受众]
- **技术参考**: [目的和受众]
- **开发者指南**: [目的和受众]
- **运维指南**: [目的和受众]

### 沟通时间表
- 活动 1: [日期、受众、目的]
- 活动 2: [日期、受众、目的]
- 活动 3: [日期、受众、目的]

### 反馈机制
[如何收集和整合反馈的描述]
```

## 📋 记忆库集成

```mermaid
flowchart TD
    classDef memfile fill:#f4b8c4,stroke:#d498a4,color:#000
    classDef process fill:#f9d77e,stroke:#d9b95c,color:#000

    Architecture[架构<br>规划] --> PB[projectbrief.md]
    Architecture --> PC[productContext.md]
    Architecture --> SP[systemPatterns.md]
    Architecture --> TC[techContext.md]

    PB & PC & SP & TC --> MBI[记忆库<br>集成]
    MBI --> Next[实施<br>阶段]

    class PB,PC,SP,TC memfile
    class Architecture,MBI,Next process
```

### 记忆库更新

在架构规划期间更新以下记忆库文件：

1. **projectbrief.md**
   - 更新架构愿景
   - 记录高层架构方法
   - 链接到架构文档

2. **productContext.md**
   - 更新业务上下文文档
   - 记录关键干系人需求
   - 捕获架构决策的业务驱动因素

3. **systemPatterns.md**
   - 记录选择的架构模式和风格
   - 捕获关键架构决策及其理由
   - 记录将要使用的技术模式

4. **techContext.md**
   - 更新技术栈决策
   - 记录技术约束和考虑因素
   - 捕获集成方法

## 📋 架构规划验证清单

```
✓ 架构规划验证清单

需求分析
- 功能需求已分析? [是/否]
- 非功能需求已分析? [是/否]
- 领域模型已创建? [是/否]
- 组件识别已完成? [是/否]

业务上下文
- 业务目标已记录? [是/否]
- 关键干系人已识别? [是/否]
- 业务流程已记录? [是/否]
- 业务约束已识别? [是/否]

愿景和目标
- 架构愿景已陈述? [是/否]
- 战略目标已定义? [是/否]
- 质量属性已识别? [是/否]
- 技术路线图已创建? [是/否]

架构原则
- 核心原则已定义? [是/否]
- 原则有明确理由? [是/否]
- 原则的影响已记录? [是/否]
- 提供了应用原则的示例? [是/否]

约束识别
- 技术约束已记录? [是/否]
- 组织约束已记录? [是/否]
- 外部约束已记录? [是/否]
- 法规约束已记录? [是/否]

备选方案探索
- 识别了多个备选方案? [是/否]
- 备选方案已根据标准评估? [是/否]
- 优缺点已记录? [是/否]
- 推荐方案有理由? [是/否]

架构文档
- 系统上下文已记录? [是/否]
- 高层架构已记录? [是/否]
- 组件架构已记录? [是/否]
- 数据架构已记录? [是/否]
- 安全架构已记录? [是/否]
- 部署架构已记录? [是/否]

架构验证
- 需求覆盖已验证? [是/否]
- 原则对齐已检查? [是/否]
- 质量属性场景已评估? [是/否]
- 架构评审已进行? [是/否]

记忆库集成
- projectbrief.md 已更新? [是/否]
- productContext.md 已更新? [是/否]
- systemPatterns.md 已更新? [是/否]
- techContext.md 已更新? [是/否]
```

## 📋 精简模式架构规划格式

对于需要更紧凑架构规划方法的情况：

```markdown
## Level 4 架构规划: [系统名称]

### 系统上下文
- **目的**: [系统目的的简要描述]
- **用户**: [主要用户]
- **外部系统**: [关键外部系统]

### 关键架构决策
- **架构风格**: [选择的风格及简要理由]
- **组件结构**: [关键组件及简要描述]
- **数据模型**: [数据方法的简要描述]
- **技术栈**: [关键技术]

### 质量属性
- **性能**: [方法的简要描述]
- **安全**: [方法的简要描述]
- **可扩展性**: [方法的简要描述]
- **可维护性**: [方法的简要描述]

### 架构图
[简单架构图]

### 关键风险和缓解措施
- **风险 1**: [简要描述] - **缓解措施**: [简要方法]
- **风险 2**: [简要描述] - **缓解措施**: [简要方法]

### 记忆库更新
- [需要更新的简要描述]
```

## 🚨 架构规划强制原则

```
┌─────────────────────────────────────────────────────┐
│ 架构规划对于 Level 4 任务是强制性的。                 │
│ 在架构规划完成并批准之前，不能开始实施。              │
└─────────────────────────────────────────────────────┘
```
